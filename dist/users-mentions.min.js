"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}();!function(e,t){e.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g,variable:"rc"};var s=function(){function t(e,s){_classCallCheck(this,t);var n=document.createElement("div");n.classList.add("users-mention-wrapper"),s.parentNode.insertBefore(n,s),n.appendChild(s),this.settup=this.prepareSettup(e),this.field=s,this.wrapper=n,this.field.addEventListener("input",this.userInputEvent.bind(this),!1)}return _createClass(t,[{key:"prepareSettup",value:function(t){return e.defaults(t,{requestUrl:"",userList:[],getMentionsData:null,searchPattern:"^[a-z0-9]+(?:-[a-z0-9]+)*$",triggerChar:"@",lengthStartSearch:3,templates:{container:e.template("\n              <div class='users-mention-list'>\n                <%= rc.userListTemplate %>\n              </div>\n            "),userList:e.template("\n              <ul>\n              <% _.forEach(rc.userList, function(user) { %>\n                <li data-slug='<%= user.slug %>'>\n                  <%= user.slug %>\n                  <small><%= user.name %></small>\n                </li>\n              <% }); %>\n              </ul>\n\n              <select id='users-mention-list-select'>\n                <% _.forEach(rc.userList, (user) => { %>\n                  <option value='<%= user.slug %>'>\n                    <%= user.slug %>\n                  </option>\n                <% }); %>\n              </select>\n            ")}}),t}},{key:"userInputEvent",value:function(e){var t=this.verifyIfHasMention();t&&this.searchForMentions(this.getCurrentMention())}},{key:"verifyIfHasMention",value:function(){var e=!1,t=new RegExp(this.settup.searchPattern,"g"),s=this.getCurrentMention();return s.length>=this.settup.lengthStartSearch&&(e=t.test(s)),e}},{key:"getCurrentMention",value:function(){var e=this.field.value,t=this.field.selectionStart,s=e.lastIndexOf(this.settup.triggerChar,t),n="";return s!==-1&&" "!==e.charAt(t-1)&&(n=e.slice(s+1,t)),n}},{key:"searchForMentions",value:function(e){var t=new XMLHttpRequest,s="mention="+encodeURIComponent(e),n=this.settup.requestUrl+"?"+s,r=this;if(/^\/.*$/.test(n)){var i=window.location.href.replace(/\/$/,"");n=i+n}t.open("GET",n,!0),t.onreadystatechange=function(){if(t.readyState===t.DONE&&200===t.status){var e=JSON.parse(t.responseText);r.populateUserList(e)}},t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.send(s)}},{key:"populateUserList",value:function(e){this.settup.userList=e,this.displayUserSelection()}},{key:"displayUserSelection",value:function(){var e=this.buildTemplates();this.currentMention=this.getCurrentMention(),this.removeUsersListDiv(),this.field.insertAdjacentHTML("afterend",e),this.usersListDIV=this.wrapper.querySelector(".users-mention-list"),this.field.onkeyup=this.fieldKeyUpEvent.bind(this);var t=this.usersListDIV.querySelector("ul");t.onclick=this.usersListUlOnClickEvent.bind(this)}},{key:"removeUsersListDiv",value:function(){this.usersListDIV&&(this.wrapper.removeChild(this.usersListDIV),this.usersListDIV=null)}},{key:"buildTemplates",value:function(){var e=this.settup.templates.userList({userList:this.settup.userList}),t=this.settup.templates.container({userListTemplate:e});return t}},{key:"fieldKeyUpEvent",value:function(e){if(40===e.keyCode||38===e.keyCode){this.field.blur();var t=this.usersListDIV.querySelector("select");t.focus(),t.selectedIndex=0,t.onchange=this.usersListSelectChangeEvent.bind(this),t.onkeypress=this.usersListSelectOnKeyPress.bind(this);var s=this.usersListDIV.querySelector("ul li");s.className="selected"}}},{key:"usersListSelectChangeEvent",value:function(e){var t=new RegExp(e.target.value),s=this.usersListDIV.querySelectorAll("ul li"),n=this.usersListDIV.querySelectorAll("ul li.selected");[].forEach.call(n,function(e){return e.className=""});var r=[].filter.call(s,function(e){return t.test(e.textContent)});if(r.length){var i=r[0];i.className="selected"}}},{key:"usersListSelectOnKeyPress",value:function(e){13===e.keyCode&&this.chooseMention(e.target.value)}},{key:"usersListUlOnClickEvent",value:function(e){var t=e.target;"LI"!==t.tagName&&(t=t.parentNode);var s=t.getAttribute("data-slug");this.chooseMention(s)}},{key:"chooseMention",value:function(e){this.removeUsersListDiv();var t=new RegExp("(@"+this.currentMention+" )|(@"+this.currentMention+"$)","g");this.field.value=this.field.value.replace(t,"@"+e+" "),this.field.focus()}}]),t}();document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll("textarea[data-users-mention-field]");[].forEach.call(e,function(e){var t=[].filter.call(e.attributes,function(e){return/^data-(?!users-mention)/.test(e.name)}),n={};t.forEach(function(e){var t=e.name.replace("data-","");t=t.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()});var s=e.value;n[t]=s}),new s(n,e)})},!1)}(_.runInContext());
