"use strict";!function(e,t){function s(e,t){var s=document.createElement("div");s.classList.add("users-mention-wrapper"),t.parentNode.insertBefore(s,t),s.appendChild(t),this.settup=this.prepareSettup(e),this.field=t,this.wrapper=s,this.field.addEventListener("input",this.userInputEvent.bind(this),!1)}e.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g,variable:"rc"},s.prototype.prepareSettup=function(t){return e.defaults(t,{requestUrl:"",userList:[],getMentionsData:null,searchPattern:"^[a-z0-9]+(?:-[a-z0-9]+)*$",triggerChar:"@",lengthStartSearch:3,templates:{container:e.template("\n            <div class='users-mention-list'>\n              <%= rc.userListTemplate %>\n            </div>\n          "),userList:e.template("\n            <ul>\n            <% _.forEach(rc.userList, function(user) { %>\n              <li data-slug='<%= user.slug %>'>\n                <%= user.slug %>\n                <small><%= user.name %></small>\n              </li>\n            <% }); %>\n            </ul>\n\n            <select id='users-mention-list-select'>\n              <% _.forEach(rc.userList, (user) => { %>\n                <option value='<%= user.slug %>'>\n                  <%= user.slug %>\n                </option>\n              <% }); %>\n            </select>\n          ")}}),t},s.prototype.userInputEvent=function(e){var t=this.verifyIfHasMention();t&&this.searchForMentions(this.getCurrentMention())},s.prototype.verifyIfHasMention=function(){var e=!1,t=new RegExp(this.settup.searchPattern,"g"),s=this.getCurrentMention();return s.length>=this.settup.lengthStartSearch&&(e=t.test(s)),e},s.prototype.getCurrentMention=function(){var e=this.field.value,t=this.field.selectionStart,s=e.lastIndexOf(this.settup.triggerChar,t),n="";return s!==-1&&" "!==e.charAt(t-1)&&(n=e.slice(s+1,t)),n},s.prototype.searchForMentions=function(e){var t=new XMLHttpRequest,s="mention="+encodeURIComponent(e),n=this.settup.requestUrl+"?"+s,r=this;if(/^\/.*$/.test(n)){var i=window.location.href.replace(/\/$/,"");n=i+n}t.open("GET",n,!0),t.onreadystatechange=function(){if(t.readyState===t.DONE&&200===t.status){var e=JSON.parse(t.responseText);r.populateUserList(e)}},t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.send(s)},s.prototype.populateUserList=function(e){this.settup.userList=e,this.displayUserSelection()},s.prototype.displayUserSelection=function(){var e=this.buildTemplates();this.currentMention=this.getCurrentMention(),this.removeUsersListDiv(),this.field.insertAdjacentHTML("afterend",e),this.usersListDIV=this.wrapper.querySelector(".users-mention-list"),this.field.onkeyup=this.fieldKeyUpEvent.bind(this);var t=this.usersListDIV.querySelector("ul");t.onclick=this.usersListUlOnClickEvent.bind(this)},s.prototype.removeUsersListDiv=function(){this.usersListDIV&&(this.wrapper.removeChild(this.usersListDIV),this.usersListDIV=null)},s.prototype.buildTemplates=function(){var e=this.settup.templates.userList({userList:this.settup.userList}),t=this.settup.templates.container({userListTemplate:e});return t},s.prototype.fieldKeyUpEvent=function(e){if(40===e.keyCode||38===e.keyCode){this.field.blur();var t=this.usersListDIV.querySelector("select");t.focus(),t.selectedIndex=0,t.onchange=this.usersListSelectChangeEvent.bind(this),t.onkeypress=this.usersListSelectOnKeyPress.bind(this);var s=this.usersListDIV.querySelector("ul li");s.className="selected"}},s.prototype.usersListSelectChangeEvent=function(e){var t=new RegExp(e.target.value),s=this.usersListDIV.querySelectorAll("ul li"),n=this.usersListDIV.querySelectorAll("ul li.selected");[].forEach.call(n,function(e){return e.className=""});var r=[].filter.call(s,function(e){return t.test(e.textContent)});if(r.length){var i=r[0];i.className="selected"}},s.prototype.usersListSelectOnKeyPress=function(e){13===e.keyCode&&this.chooseMention(e.target.value)},s.prototype.usersListUlOnClickEvent=function(e){var t=e.target;"LI"!==t.tagName&&(t=t.parentNode);var s=t.getAttribute("data-slug");this.chooseMention(s)},s.prototype.chooseMention=function(e){this.removeUsersListDiv(),console.log("Selected: "+e,this.currentMention),this.field.value=this.field.value.replace("@"+this.currentMention,"@"+e),this.field.focus()},document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll("textarea[data-users-mention-field]");[].forEach.call(e,function(e){var t=[].filter.call(e.attributes,function(e){return/^data-(?!users-mention)/.test(e.name)}),n={};t.forEach(function(e){var t=e.name.replace("data-","");t=t.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()});var s=e.value;n[t]=s});new s(n,e)})},!1)}(_.runInContext());
